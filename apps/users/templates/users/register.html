{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/css/register.css' %}">
<style>
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
        display: flex;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .password-modal {
        background: white;
        border-radius: 16px;
        padding: 0;
        max-width: 550px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.4s ease;
        overflow: hidden;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .modal-header i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
    }

    .modal-header h3 {
        margin: 0 0 8px 0;
        font-size: 24px;
        font-weight: 600;
    }

    .modal-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 14px;
    }

    .modal-body {
        padding: 30px;
    }

    .user-info {
        background: #f5f5f5;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .user-info-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .user-info-item:last-child {
        border-bottom: none;
    }

    .user-info-label {
        font-weight: 600;
        color: #616161;
        font-size: 14px;
    }

    .user-info-value {
        color: #212121;
        font-size: 14px;
        text-align: right;
        max-width: 60%;
        word-break: break-word;
    }

    .password-display {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border: 2px dashed #43a047;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
        text-align: center;
    }

    .password-display-label {
        font-size: 13px;
        color: #2e7d32;
        font-weight: 600;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .password-value {
        font-family: 'Courier New', monospace;
        font-size: 24px;
        font-weight: 700;
        color: #1b5e20;
        letter-spacing: 2px;
        margin: 10px 0;
        user-select: all;
        cursor: pointer;
        word-break: break-all;
    }

    .copy-btn {
        background: #43a047;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
        transition: all 0.3s ease;
    }

    .copy-btn:hover {
        background: #388e3c;
        transform: translateY(-2px);
    }

    .copy-btn.copied {
        background: #2e7d32;
    }

    .warning-box {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        font-size: 13px;
        color: #e65100;
    }

    .warning-box i {
        margin-right: 8px;
    }

    .email-status {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        border-radius: 8px;
        margin: 15px 0;
        font-size: 14px;
    }

    .email-status.success {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .email-status.warning {
        background: #fff3e0;
        color: #e65100;
    }

    .email-status i {
        margin-right: 8px;
        font-size: 18px;
    }

    .modal-footer {
        padding: 20px 30px;
        background: #f9f9f9;
        text-align: center;
    }

    .btn-close-modal {
        background: #43a047;
        color: white;
        border: none;
        padding: 14px 40px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-close-modal:hover {
        background: #388e3c;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(67, 160, 71, 0.3);
    }

    .loading-spinner {
        display: none;
        margin-left: 10px;
    }

    .loading-spinner.active {
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="icon-circle mx-auto mb-3">
                            <i class="bi bi-person-plus-fill"></i>
                        </div>
                        <h3 class="card-title text-success fw-bold">Registro de Usuario</h3>
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {% if message.tags == 'success' %}
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                {% elif message.tags == 'error' %}
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                {% elif message.tags == 'warning' %}
                                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                                {% else %}
                                    <i class="bi bi-info-circle-fill me-2"></i>
                                {% endif %}
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" id="registerForm" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-person me-1"></i>{{ form.first_name.label }}
                            </label>
                            {{ form.first_name }}
                            <div class="invalid-feedback"></div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.last_name.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-person me-1"></i>{{ form.last_name.label }}
                            </label>
                            {{ form.last_name }}
                            <div class="invalid-feedback"></div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.cedula.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-credit-card me-1"></i>{{ form.cedula.label }}
                            </label>
                            {{ form.cedula }}
                            <div class="form-text">Ingrese número de cédula</div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-envelope me-1"></i>{{ form.email.label }}
                            </label>
                            {{ form.email }}
                            <div class="invalid-feedback"></div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.empresa.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-building me-1"></i>{{ form.empresa.label }}
                            </label>
                            {{ form.empresa }}
                            <div class="invalid-feedback"></div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.rol.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-shield-check me-1"></i>{{ form.rol.label }}
                            </label>
                            {{ form.rol }}
                            <div class="invalid-feedback"></div>
                        </div>

                        <div class="alert alert-info border-0 mb-4">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <small>Se generará una contraseña temporal que será enviada al correo del usuario.</small>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <a href="{% url 'users:users_list' %}" class="btn btn-secondary px-4">
                                <i class="bi bi-x-circle me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-success px-4" id="submitBtn">
                                <i class="bi bi-check-circle me-1"></i>Registrar
                                <span class="loading-spinner spinner-border spinner-border-sm" role="status"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de contraseña temporal -->
<div class="modal-overlay" id="passwordModal">
    <div class="password-modal">
        <div class="modal-header">
            <i class="bi bi-check-circle-fill"></i>
            <h3>¡Usuario Registrado Exitosamente!</h3>
            <p>El usuario ha sido creado correctamente</p>
        </div>
        
        <div class="modal-body">
            <div class="user-info">
                <div class="user-info-item">
                    <span class="user-info-label">Nombre:</span>
                    <span class="user-info-value" id="modalNombre"></span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Cédula:</span>
                    <span class="user-info-value" id="modalCedula"></span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Correo:</span>
                    <span class="user-info-value" id="modalEmail"></span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Rol:</span>
                    <span class="user-info-value" id="modalRol"></span>
                </div>
            </div>

            <div class="password-display">
                <div class="password-display-label">
                    <i class="bi bi-key-fill"></i> Contraseña Temporal
                </div>
                <div class="password-value" id="modalPassword" onclick="copyPassword()">
                    **************
                </div>
                <button class="copy-btn" id="copyBtn" onclick="copyPassword()">
                    <i class="bi bi-clipboard"></i> Copiar Contraseña
                </button>
            </div>

            <div class="email-status" id="emailStatus"></div>

            <div class="warning-box">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>Importante:</strong> Guarde esta contraseña en un lugar seguro. 
                El usuario deberá cambiarla obligatoriamente en su primer inicio de sesión.
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-close-modal" onclick="closeModal()">
                <i class="bi bi-check-lg me-2"></i>Entendido
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.loading-spinner');
    
    // Limpiar errores previos
    document.querySelectorAll('.invalid-feedback').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
    });
    document.querySelectorAll('.form-control').forEach(el => {
        el.classList.remove('is-invalid');
    });
    
    // Mostrar spinner
    submitBtn.disabled = true;
    spinner.classList.add('active');
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.disabled = false;
        spinner.classList.remove('active');
        
        if (data.success) {
            showPasswordModal(data.user_data);
            this.reset();
        } else {
            for (const [field, errors] of Object.entries(data.errors)) {
                const input = document.getElementById(`id_${field}`);
                if (input) {
                    input.classList.add('is-invalid');
                    const feedback = input.parentElement.querySelector('.invalid-feedback');
                    if (feedback) {
                        feedback.textContent = errors[0];
                        feedback.style.display = 'block';
                    }
                }
            }
        }
    })
    .catch(error => {
        submitBtn.disabled = false;
        spinner.classList.remove('active');
        alert('Error al procesar la solicitud. Por favor, intente nuevamente.');
        console.error('Error:', error);
    });
});

function showPasswordModal(userData) {
    document.getElementById('modalNombre').textContent = `${userData.nombre} ${userData.apellido}`;
    document.getElementById('modalCedula').textContent = userData.cedula;
    document.getElementById('modalEmail').textContent = userData.email;
    document.getElementById('modalRol').textContent = userData.rol;
    document.getElementById('modalPassword').textContent = userData.temp_password;
    
    const emailStatus = document.getElementById('emailStatus');
    if (userData.email_sent) {
        emailStatus.className = 'email-status success';
        emailStatus.innerHTML = '<i class="bi bi-check-circle-fill"></i> Contraseña enviada por correo electrónico';
    } else {
        emailStatus.className = 'email-status warning';
        emailStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> No se pudo enviar el correo. Comparta la contraseña manualmente.';
    }
    
    document.getElementById('passwordModal').classList.add('active');
}

function closeModal() {
    document.getElementById('passwordModal').classList.remove('active');
    window.location.href = "{% url 'users:users_list' %}";
}

function copyPassword() {
    const password = document.getElementById('modalPassword').textContent;
    const copyBtn = document.getElementById('copyBtn');
    
    navigator.clipboard.writeText(password).then(() => {
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="bi bi-check2"></i> ¡Copiado!';
        copyBtn.classList.add('copied');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        alert('Error al copiar. Por favor, seleccione y copie manualmente.');
    });
}

document.getElementById('passwordModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}